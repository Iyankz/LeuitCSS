{% extends "base.html" %}

{% block title %}Backup Detail{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1>
            <span class="badge badge-vendor badge-{{ backup.vendor }} me-2">{{ backup.vendor|upper }}</span>
            {{ backup.device_name }}
        </h1>
        <p class="text-muted mb-0">
            Backup from {{ backup.started_at.strftime('%Y-%m-%d %H:%M:%S') }}
        </p>
    </div>
    <div class="btn-group">
        {% if backup.file_path %}
        <a href="{{ url_for('backup.backup_view', backup_id=backup.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-eye"></i> View Config
        </a>
        <a href="{{ url_for('backup.backup_download', backup_id=backup.id) }}" class="btn btn-success">
            <i class="bi bi-download"></i> Download
        </a>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Backup Info -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Backup Information
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td class="text-muted" style="width:40%;">Status</td>
                        <td>
                            <span class="status-badge status-{{ backup.status }}">
                                {% if backup.status == 'success' %}
                                <i class="bi bi-check-circle"></i>
                                {% elif backup.status == 'failed' %}
                                <i class="bi bi-x-circle"></i>
                                {% elif backup.status == 'timeout' %}
                                <i class="bi bi-clock"></i>
                                {% else %}
                                <i class="bi bi-hourglass"></i>
                                {% endif %}
                                {{ backup.status|upper }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Device</td>
                        <td>
                            <a href="{{ url_for('main.device_detail', device_id=backup.device_id) }}">
                                {{ backup.device_name }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">IP Address</td>
                        <td><code>{{ backup.device_ip }}</code></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Vendor</td>
                        <td>{{ backup.vendor|upper }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Connection</td>
                        <td>{{ backup.connection_type|upper }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Backup Command</td>
                        <td><code>{{ backup.backup_command }}</code></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Triggered By</td>
                        <td>{{ backup.triggered_by|capitalize }}</td>
                    </tr>
                    {% if backup.retry_count > 0 %}
                    <tr>
                        <td class="text-muted">Retry Count</td>
                        <td>{{ backup.retry_count }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
        
        {% if backup.error_message %}
        <div class="card mb-4 border-danger">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-exclamation-triangle"></i> Error Details
            </div>
            <div class="card-body">
                <pre class="mb-0 text-danger">{{ backup.error_message }}</pre>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Execution Details -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Execution Details
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td class="text-muted" style="width:40%;">Started</td>
                        <td>{{ backup.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Completed</td>
                        <td>
                            {% if backup.completed_at %}
                            {{ backup.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Duration</td>
                        <td>
                            {% if backup.execution_time_seconds %}
                            {{ backup.execution_time_seconds }} seconds
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        
        {% if backup.file_path %}
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-file-earmark"></i> File Details
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td class="text-muted" style="width:40%;">File Path</td>
                        <td><code class="small">{{ backup.file_path }}</code></td>
                    </tr>
                    <tr>
                        <td class="text-muted">File Size</td>
                        <td>
                            {% if backup.file_size_bytes %}
                            {{ (backup.file_size_bytes / 1024)|round(2) }} KB
                            ({{ backup.file_size_bytes }} bytes)
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">SHA256 Checksum</td>
                        <td>
                            {% if backup.checksum_sha256 %}
                            <code class="small">{{ backup.checksum_sha256[:32] }}...</code>
                            {% if checksum_valid is not none %}
                            {% if checksum_valid %}
                            <span class="badge bg-success">Verified</span>
                            {% else %}
                            <span class="badge bg-danger">Mismatch!</span>
                            {% endif %}
                            {% endif %}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        {% endif %}
        
        {% if metadata %}
        <div class="card">
            <div class="card-header">
                <i class="bi bi-file-text"></i> Stored Metadata
            </div>
            <div class="card-body">
                <pre class="mb-0 small" style="max-height: 200px; overflow: auto;">{{ metadata | tojson(indent=2) }}</pre>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('backup.backup_list') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to List
    </a>
    <a href="{{ url_for('main.device_detail', device_id=backup.device_id) }}" class="btn btn-outline-primary">
        <i class="bi bi-router"></i> View Device
    </a>
</div>
{% endblock %}
